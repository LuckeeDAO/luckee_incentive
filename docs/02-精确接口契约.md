# Luckee Incentive 精确接口契约

## 📋 文档信息

- **项目名称**: Luckee Incentive (激励合约)
- **版本**: v1.0
- **文档类型**: 精确接口契约
- **标准**: OpenAPI Specification 3.0
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档定义了Luckee Incentive合约的所有接口，包括请求/响应格式、状态码、错误类型和数据验证规则。作为AI之间、系统与系统之间交互的"法律文书"，确保无缝集成。

## 📡 合约接口规范

### 1. 实例化接口 (InstantiateMsg)

```yaml
openapi: 3.0.0
info:
  title: Luckee Incentive Contract API
  version: 1.0.0
  description: Luckee Incentive激励合约接口规范

paths:
  /instantiate:
    post:
      summary: 实例化合约
      description: 创建新的Luckee Incentive合约实例
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InstantiateMsg'
      responses:
        '200':
          description: 实例化成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstantiateResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    InstantiateMsg:
      type: object
      required:
        - admin
        - ft_contract
        - registry_contract
        - config
      properties:
        admin:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: 管理员地址
          example: "luckee1abc123..."
        ft_contract:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: FT合约地址
          example: "luckee1ft123..."
        registry_contract:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: 注册合约地址
          example: "luckee1reg123..."
        config:
          $ref: '#/components/schemas/ContractConfig'

    ContractConfig:
      type: object
      required:
        - enabled
        - emergency_paused
      properties:
        enabled:
          type: boolean
          description: 系统是否启用
          example: true
        emergency_paused:
          type: boolean
          description: 是否紧急暂停
          example: false

    InstantiateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        contract_address:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          example: "luckee1jkl012..."
        config:
          $ref: '#/components/schemas/ContractConfig'
```

### 2. 执行接口 (ExecuteMsg)

```yaml
  /execute:
    post:
      summary: 执行合约操作
      description: 执行激励相关操作
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteMsg'
      responses:
        '200':
          description: 执行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    ExecuteMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/DistributeRewardMsg'
        - $ref: '#/components/schemas/MintForPointsMsg'
        - $ref: '#/components/schemas/UpdateRulesMsg'
        - $ref: '#/components/schemas/RegisterContractMsg'
        - $ref: '#/components/schemas/AdminMsg'

    DistributeRewardMsg:
      type: object
      required:
        - distribute_reward
      properties:
        distribute_reward:
          type: object
          required:
            - activity_type
            - user
            - activity_data
          properties:
            activity_type:
              type: string
              enum: ["blind_box_open", "nft_mint", "voting", "referral_reward", "special_event"]
              description: 活动类型
            user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 用户地址
            activity_data:
              type: object
              description: 活动相关数据
              properties:
                value:
                  type: string
                  description: 活动价值
                metadata:
                  type: object
                  description: 活动元数据
            event_id:
              type: string
              description: 事件ID（可选）
              nullable: true

    MintForPointsMsg:
      type: object
      required:
        - mint_for_points
      properties:
        mint_for_points:
          type: object
          required:
            - user
            - points_amount
          properties:
            user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 用户地址
            points_amount:
              type: string
              pattern: '^[0-9]+$'
              minimum: "1000"
              description: 积分数量

    UpdateRulesMsg:
      type: object
      required:
        - update_rules
      properties:
        update_rules:
          type: object
          required:
            - rules
            - version
          properties:
            rules:
              $ref: '#/components/schemas/RewardRules'
            version:
              type: integer
              minimum: 1
              description: 规则版本号

    RegisterContractMsg:
      type: object
      required:
        - register_contract
      properties:
        register_contract:
          type: object
          required:
            - contract_address
            - contract_type
            - permissions
          properties:
            contract_address:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 合约地址
            contract_type:
              type: string
              enum: ["blind_box", "nft", "voting", "registry"]
              description: 合约类型
            permissions:
              type: array
              items:
                type: string
                enum: ["distribute_reward", "query_points", "mint_tokens"]
              description: 权限列表

    AdminMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/UpdateConfigMsg'
        - $ref: '#/components/schemas/EmergencyPauseMsg'

    UpdateConfigMsg:
      type: object
      required:
        - update_config
      properties:
        update_config:
          type: object
          required:
            - config
          properties:
            config:
              $ref: '#/components/schemas/ContractConfig'

    EmergencyPauseMsg:
      type: object
      required:
        - emergency_pause
      properties:
        emergency_pause:
          type: object
          required:
            - paused
          properties:
            paused:
              type: boolean
              description: 是否暂停

    RewardRules:
      type: object
      required:
        - activity_rules
        - referral_rules
        - level_multipliers
      properties:
        activity_rules:
          type: array
          items:
            type: object
            properties:
              activity_type:
                type: string
                enum: ["blind_box_open", "nft_mint", "voting", "referral_reward", "special_event"]
              base_reward:
                type: string
                pattern: '^[0-9]+$'
              multiplier:
                type: string
                pattern: '^[0-9]+\.[0-9]+$'
              enabled:
                type: boolean
        referral_rules:
          type: object
          properties:
            direct_rate:
              type: string
              pattern: '^0\.[0-9]+$'
            level_2_rate:
              type: string
              pattern: '^0\.[0-9]+$'
            level_3_rate:
              type: string
              pattern: '^0\.[0-9]+$'
        level_multipliers:
          type: object
          properties:
            Bronze:
              type: string
              pattern: '^[0-9]+\.[0-9]+$'
            Silver:
              type: string
              pattern: '^[0-9]+\.[0-9]+$'
            Gold:
              type: string
              pattern: '^[0-9]+\.[0-9]+$'
            Platinum:
              type: string
              pattern: '^[0-9]+\.[0-9]+$'

    ExecuteResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        transaction_hash:
          type: string
          description: 交易哈希
          example: "0x1234567890abcdef..."
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: 事件列表
```

### 3. 查询接口 (QueryMsg)

```yaml
  /query:
    post:
      summary: 查询合约状态
      description: 查询激励相关信息
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryMsg'
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/RewardHistoryResponse'
                  - $ref: '#/components/schemas/SystemStatsResponse'
                  - $ref: '#/components/schemas/ConfigResponse'
                  - $ref: '#/components/schemas/RegisteredContractsResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    QueryMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/RewardHistoryQuery'
        - $ref: '#/components/schemas/SystemStatsQuery'
        - $ref: '#/components/schemas/ConfigQuery'
        - $ref: '#/components/schemas/RegisteredContractsQuery'

    RewardHistoryQuery:
      type: object
      required:
        - get_reward_history
      properties:
        get_reward_history:
          type: object
          required:
            - user
          properties:
            user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 用户地址
            limit:
              type: integer
              minimum: 1
              maximum: 1000
              description: 返回数量限制
              default: 50
            offset:
              type: integer
              minimum: 0
              description: 偏移量
              default: 0
            activity_type:
              type: string
              enum: ["blind_box_open", "nft_mint", "voting", "referral_reward", "special_event"]
              description: 活动类型过滤（可选）
              nullable: true

    SystemStatsQuery:
      type: object
      required:
        - get_system_stats
      properties:
        get_system_stats:
          type: object
          properties:
            period:
              type: string
              enum: ["daily", "weekly", "monthly", "all"]
              description: 统计周期
              default: "all"

    ConfigQuery:
      type: object
      required:
        - get_config
      properties:
        get_config:
          type: object
          description: 查询合约配置

    RegisteredContractsQuery:
      type: object
      required:
        - get_registered_contracts
      properties:
        get_registered_contracts:
          type: object
          description: 查询注册的合约

    RewardHistoryResponse:
      type: object
      properties:
        reward_history:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: integer
                description: 时间戳
              activity_type:
                type: string
                description: 活动类型
              amount:
                type: string
                pattern: '^[0-9]+$'
                description: 奖励金额
              event_id:
                type: string
                nullable: true
                description: 事件ID
              transaction_hash:
                type: string
                description: 交易哈希
        total_rewards:
          type: string
          pattern: '^[0-9]+$'
          description: 总奖励
        total_count:
          type: integer
          description: 总数量

    SystemStatsResponse:
      type: object
      properties:
        total_rewards_distributed:
          type: string
          pattern: '^[0-9]+$'
          description: 总分发奖励
        total_users:
          type: integer
          description: 总用户数
        total_activities:
          type: integer
          description: 总活动数
        activity_breakdown:
          type: object
          properties:
            blind_box_open:
              type: integer
              description: 盲盒开奖次数
            nft_mint:
              type: integer
              description: NFT铸造次数
            voting:
              type: integer
              description: 投票次数
            referral_reward:
              type: integer
              description: 推荐奖励次数
            special_event:
              type: integer
              description: 特殊活动次数
        average_reward_per_user:
          type: string
          pattern: '^[0-9]+$'
          description: 平均每用户奖励
        top_reward_users:
          type: array
          items:
            type: object
            properties:
              user:
                type: string
                pattern: '^luckee[a-z0-9]{38}$'
                description: 用户地址
              total_rewards:
                type: string
                pattern: '^[0-9]+$'
                description: 总奖励
              activity_count:
                type: integer
                description: 活动次数

    ConfigResponse:
      type: object
      properties:
        config:
          $ref: '#/components/schemas/ContractConfig'
        admin:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: 管理员地址
        ft_contract:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: FT合约地址
        registry_contract:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: 注册合约地址

    RegisteredContractsResponse:
      type: object
      properties:
        contracts:
          type: array
          items:
            type: object
            properties:
              contract_address:
                type: string
                pattern: '^luckee[a-z0-9]{38}$'
                description: 合约地址
              contract_type:
                type: string
                enum: ["blind_box", "nft", "voting", "registry"]
                description: 合约类型
              permissions:
                type: array
                items:
                  type: string
                  enum: ["distribute_reward", "query_points", "mint_tokens"]
                description: 权限列表
              registered_at:
                type: integer
                description: 注册时间戳
        total_count:
          type: integer
          description: 总合约数
```

### 4. 错误响应规范

```yaml
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: 错误代码
              example: "UNAUTHORIZED"
            message:
              type: string
              description: 错误消息
              example: "调用者无权限执行此操作"
            details:
              type: object
              description: 错误详情
              properties:
                field:
                  type: string
                  description: 错误字段
                  example: "user"
                value:
                  type: string
                  description: 错误值
                  example: "luckee1invalid..."
                suggestion:
                  type: string
                  description: 修复建议
                  example: "使用有效的用户地址"

    ErrorCodes:
      type: object
      properties:
        UNAUTHORIZED:
          type: object
          properties:
            code: "UNAUTHORIZED"
            message: "调用者无权限执行此操作"
            http_status: 401
        USER_NOT_FOUND:
          type: object
          properties:
            code: "USER_NOT_FOUND"
            message: "用户不存在"
            http_status: 404
        UNSUPPORTED_ACTIVITY:
          type: object
          properties:
            code: "UNSUPPORTED_ACTIVITY"
            message: "不支持的活动类型"
            http_status: 400
        SYSTEM_PAUSED:
          type: object
          properties:
            code: "SYSTEM_PAUSED"
            message: "系统已暂停"
            http_status: 503
        REWARD_CALCULATION_FAILED:
          type: object
          properties:
            code: "REWARD_CALCULATION_FAILED"
            message: "奖励计算失败"
            http_status: 500
        MINT_FAILED:
          type: object
          properties:
            code: "MINT_FAILED"
            message: "代币铸造失败"
            http_status: 500
        INSUFFICIENT_POINTS:
          type: object
          properties:
            code: "INSUFFICIENT_POINTS"
            message: "积分不足"
            http_status: 400
        INVALID_RULES:
          type: object
          properties:
            code: "INVALID_RULES"
            message: "无效的规则配置"
            http_status: 400
        CONTRACT_ALREADY_EXISTS:
          type: object
          properties:
            code: "CONTRACT_ALREADY_EXISTS"
            message: "合约已存在"
            http_status: 400
```

## 🔒 数据验证规则

### 1. 地址验证

```yaml
address_validation:
  pattern: '^luckee[a-z0-9]{38}$'
  description: "Luckee地址格式验证"
  examples:
    valid: "luckee1abc123def456ghi789jkl012mno345pqr678stu901vwx234"
    invalid: "cosmos1abc123..." # 错误的地址前缀
    invalid: "luckee1abc" # 地址长度不足
```

### 2. 积分数量验证

```yaml
points_validation:
  pattern: '^[0-9]+$'
  minimum: "1000"
  maximum: "1000000000000000000"
  description: "积分数量验证"
  examples:
    valid: "1000000" # 100万积分
    valid: "1000" # 最小单位
    invalid: "999" # 低于最小值
    invalid: "1000000000000000001" # 超过最大值
    invalid: "1.5" # 不能有小数
    invalid: "-1000000" # 不能为负数
```

### 3. 活动类型验证

```yaml
activity_type_validation:
  enum: ["blind_box_open", "nft_mint", "voting", "referral_reward", "special_event"]
  description: "活动类型验证"
  examples:
    valid: "blind_box_open"
    valid: "nft_mint"
    invalid: "invalid_activity" # 不支持的活动类型
```

### 4. 合约类型验证

```yaml
contract_type_validation:
  enum: ["blind_box", "nft", "voting", "registry"]
  description: "合约类型验证"
  examples:
    valid: "blind_box"
    valid: "nft"
    invalid: "invalid_contract" # 不支持的合约类型
```

## 📊 状态码映射

```yaml
status_code_mapping:
  success:
    http_status: 200
    cosmwasm_status: "success"
    description: "操作成功"
  
  bad_request:
    http_status: 400
    cosmwasm_status: "failure"
    description: "请求参数错误"
    error_codes:
      - "UNSUPPORTED_ACTIVITY"
      - "INSUFFICIENT_POINTS"
      - "INVALID_RULES"
      - "CONTRACT_ALREADY_EXISTS"
  
  unauthorized:
    http_status: 401
    cosmwasm_status: "failure"
    description: "权限不足"
    error_codes:
      - "UNAUTHORIZED"
  
  not_found:
    http_status: 404
    cosmwasm_status: "failure"
    description: "资源不存在"
    error_codes:
      - "USER_NOT_FOUND"
  
  internal_server_error:
    http_status: 500
    cosmwasm_status: "failure"
    description: "内部服务器错误"
    error_codes:
      - "REWARD_CALCULATION_FAILED"
      - "MINT_FAILED"
  
  service_unavailable:
    http_status: 503
    cosmwasm_status: "failure"
    description: "服务不可用"
    error_codes:
      - "SYSTEM_PAUSED"
```

## 🔄 版本兼容性

```yaml
version_compatibility:
  current_version: "1.0.0"
  supported_versions:
    - "1.0.0"
  
  breaking_changes:
    v1.0.0:
      - "初始版本发布"
      - "基础激励功能"
      - "多合约协调"
  
  migration_guide:
    initial_deployment:
      - "首次部署无需迁移"
      - "配置激励规则"
      - "注册业务合约"
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始接口规范创建 | AI Assistant |

---

**注意**: 本文档是AI之间、系统与系统之间交互的"法律文书"，任何接口变更都必须同步更新本文档，并通知所有相关方。
