# Luckee Incentive 部署与运维文档

## 📋 文档信息

- **项目名称**: Luckee Incentive (激励合约)
- **版本**: v1.0
- **文档类型**: 部署与运维类文档
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档由AI根据整个项目上下文自动生成，包含精确的部署流程、环境配置、监控指标和告警规则。确保交付物能被正确、高效地部署和运维。

## 🚀 部署清单与流程

### 1. 部署前准备

#### 1.1 环境要求

```yaml
environment_requirements:
  hardware:
    minimum_cpu: "4 cores"
    minimum_memory: "8GB RAM"
    minimum_storage: "100GB SSD"
    recommended_cpu: "8 cores"
    recommended_memory: "16GB RAM"
    recommended_storage: "500GB SSD"
  
  software:
    operating_system: "Ubuntu 20.04 LTS or later"
    rust_version: ">= 1.70.0"
    cosmwasm_version: ">= 1.4.0"
    wasmd_version: ">= 0.45.0"
    cosmwasm_opt_version: ">= 0.16.0"
  
  network:
    internet_connection: "Stable broadband"
    firewall_rules: "Allow ports 26656, 26657, 1317"
    dns_resolution: "Required for external connections"
```

### 2. 合约构建流程

#### 2.1 Luckee Incentive 构建

```bash
#!/bin/bash
# Luckee Incentive 构建脚本 - build_luckee_incentive.sh

set -e

echo "开始构建 Luckee Incentive 合约..."

cd /home/lc/luckee_dao/luckee_incentive

# 清理之前的构建
cargo clean

# 构建合约
RUSTFLAGS='-C link-arg=-s' cargo build --release --target wasm32-unknown-unknown

# 优化合约
cosmwasm-opt target/wasm32-unknown-unknown/release/luckee_incentive.wasm \
  -o target/wasm32-unknown-unknown/release/luckee_incentive_optimized.wasm

# 验证构建结果
ls -la target/wasm32-unknown-unknown/release/luckee_incentive_optimized.wasm

echo "Luckee Incentive 构建完成！"
echo "合约大小: $(du -h target/wasm32-unknown-unknown/release/luckee_incentive_optimized.wasm | cut -f1)"
```

### 3. 部署流程

#### 3.1 合约上传

```bash
#!/bin/bash
# 合约上传脚本 - upload_luckee_incentive.sh

set -e

echo "开始上传 Luckee Incentive 合约..."

cd /home/lc/luckee_dao/deployment

# 上传 Luckee Incentive 合约
echo "上传 Luckee Incentive 合约..."
LUCKY_INCENTIVE_CODE_ID=$(wasmd tx wasm store \
  ../luckee_incentive/target/wasm32-unknown-unknown/release/luckee_incentive_optimized.wasm \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes \
  --output json | jq -r '.logs[0].events[0].attributes[0].value')

echo "Luckee Incentive Code ID: ${LUCKY_INCENTIVE_CODE_ID}"
echo "LUCKY_INCENTIVE_CODE_ID=${LUCKY_INCENTIVE_CODE_ID}" >> contract_addresses.env

echo "Luckee Incentive 合约上传完成！"
```

#### 3.2 合约实例化

```bash
#!/bin/bash
# 合约实例化脚本 - instantiate_luckee_incentive.sh

set -e

echo "开始实例化 Luckee Incentive 合约..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 实例化 Luckee Incentive 合约
echo "实例化 Luckee Incentive 合约..."
LUCKY_INCENTIVE_CONTRACT=$(wasmd tx wasm instantiate ${LUCKY_INCENTIVE_CODE_ID} '{
  "admin": "'${ADMIN_ADDRESS}'",
  "ft_contract": "'${LUCKY_FT_CONTRACT}'",
  "registry_contract": "'${DD_REGISTRY_CONTRACT}'",
  "config": {
    "enabled": true,
    "emergency_paused": false
  }
}' \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --label "Luckee Incentive v1.0" \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes \
  --output json | jq -r '.logs[0].events[0].attributes[0].value')

echo "Luckee Incentive Contract Address: ${LUCKY_INCENTIVE_CONTRACT}"
echo "LUCKY_INCENTIVE_CONTRACT=${LUCKY_INCENTIVE_CONTRACT}" >> contract_addresses.env

echo "Luckee Incentive 合约实例化完成！"
```

### 4. 部署验证

#### 4.1 合约状态检查

```bash
#!/bin/bash
# 部署验证脚本 - verify_luckee_incentive.sh

set -e

echo "开始验证 Luckee Incentive 部署..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 检查 Luckee Incentive 合约状态
echo "检查 Luckee Incentive 合约状态..."
wasmd query wasm contract-state smart ${LUCKY_INCENTIVE_CONTRACT} '{"get_config":{}}' \
  --node ${NODE} --output json | jq '.'

echo "Luckee Incentive 部署验证完成！"
```

## 📊 监控指标和告警规则

### 1. 系统监控指标

#### 1.1 合约性能指标

```yaml
contract_performance_metrics:
  luckee_incentive:
    gas_usage:
      distribute_reward:
        threshold: 130000
        alert_level: "warning"
        critical_threshold: 150000
        
      mint_for_points:
        threshold: 90000
        alert_level: "warning"
        critical_threshold: 110000
        
      update_rules:
        threshold: 50000
        alert_level: "warning"
        critical_threshold: 70000
    
    response_time:
      distribute_reward:
        threshold: "250ms"
        alert_level: "warning"
        critical_threshold: "400ms"
        
      mint_for_points:
        threshold: "180ms"
        alert_level: "warning"
        critical_threshold: "300ms"
        
      query_operations:
        threshold: "50ms"
        alert_level: "warning"
        critical_threshold: "100ms"
```

#### 1.2 业务指标

```yaml
business_metrics:
  reward_metrics:
    total_rewards_distributed:
      threshold: 1000000000000000
      alert_level: "info"
      
    daily_reward_distributions:
      threshold: 10000
      alert_level: "info"
      critical_threshold: 1000
      
    average_reward_per_distribution:
      threshold: 1000000000
      alert_level: "info"
  
  activity_metrics:
    total_activities_processed:
      threshold: 1000000
      alert_level: "info"
      
    daily_activities:
      threshold: 10000
      alert_level: "info"
      critical_threshold: 1000
      
    activity_success_rate:
      threshold: 0.95
      alert_level: "warning"
      critical_threshold: 0.9
  
  points_metrics:
    total_points_exchanged:
      threshold: 1000000000000000
      alert_level: "info"
      
    daily_points_exchanges:
      threshold: 1000
      alert_level: "info"
      critical_threshold: 100
      
    points_exchange_success_rate:
      threshold: 0.98
      alert_level: "warning"
      critical_threshold: 0.95
```

### 2. 告警规则配置

#### 2.1 Prometheus 告警规则

```yaml
# prometheus_alerts_luckee_incentive.yml
groups:
  - name: luckee_incentive_contracts
    rules:
      # Gas 使用告警
      - alert: LuckeeIncentiveHighGasUsage
        expr: luckee_incentive_gas_usage > 150000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Luckee Incentive high gas usage detected"
          description: "Luckee Incentive contract is using {{ $value }} gas"
      
      # 响应时间告警
      - alert: LuckeeIncentiveHighResponseTime
        expr: luckee_incentive_response_time > 500
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Luckee Incentive high response time detected"
          description: "Luckee Incentive response time is {{ $value }}ms"
      
      # 奖励分发失败告警
      - alert: RewardDistributionFailure
        expr: rate(reward_distribution_failures_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High reward distribution failure rate"
          description: "Reward distribution failure rate is {{ $value }}"
      
      # 积分兑换失败告警
      - alert: PointsExchangeFailure
        expr: rate(points_exchange_failures_total[5m]) > 0.02
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High points exchange failure rate"
          description: "Points exchange failure rate is {{ $value }}"
      
      # 合约交互失败告警
      - alert: ContractInteractionFailure
        expr: rate(contract_interaction_failures_total[5m]) > 0.01
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Contract interaction failure detected"
          description: "Contract interaction failure rate is {{ $value }}"
```

## 🔧 运维手册

### 1. 日常运维任务

#### 1.1 健康检查

```bash
#!/bin/bash
# 健康检查脚本 - health_check_luckee_incentive.sh

set -e

echo "开始 Luckee Incentive 健康检查..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 检查合约状态
check_luckee_incentive_health() {
  echo "检查 Luckee Incentive 合约..."
  
  if wasmd query wasm contract-state smart ${LUCKY_INCENTIVE_CONTRACT} '{"get_config":{}}' \
    --node ${NODE} --output json > /dev/null 2>&1; then
    echo "✅ Luckee Incentive 健康"
    return 0
  else
    echo "❌ Luckee Incentive 异常"
    return 1
  fi
}

# 检查合约
check_luckee_incentive_health

echo "Luckee Incentive 健康检查完成！"
```

#### 1.2 性能监控

```bash
#!/bin/bash
# 性能监控脚本 - performance_monitor_luckee_incentive.sh

set -e

echo "开始 Luckee Incentive 性能监控..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 监控 Gas 使用
monitor_luckee_incentive_gas() {
  local operation=$1
  
  echo "监控 Luckee Incentive 的 ${operation} 操作 Gas 使用..."
  
  # 执行测试操作并记录 Gas 使用
  local gas_used=$(wasmd tx wasm execute ${LUCKY_INCENTIVE_CONTRACT} '{"'${operation}'":{}}' \
    --from ${ADMIN_ADDRESS} \
    --chain-id ${CHAIN_ID} \
    --node ${NODE} \
    --gas auto \
    --gas-adjustment 1.3 \
    --yes \
    --output json | jq -r '.gas_used')
  
  echo "Gas 使用: ${gas_used}"
  
  # 检查是否超过阈值
  if [ ${gas_used} -gt 150000 ]; then
    echo "⚠️ Gas 使用超过阈值"
  fi
}

# 监控各操作性能
monitor_luckee_incentive_gas "get_config"

echo "Luckee Incentive 性能监控完成！"
```

### 2. 故障处理

#### 2.1 紧急暂停

```bash
#!/bin/bash
# 紧急暂停脚本 - emergency_pause_luckee_incentive.sh

set -e

echo "执行 Luckee Incentive 紧急暂停..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 暂停 Luckee Incentive 合约
echo "暂停 Luckee Incentive 合约..."

wasmd tx wasm execute ${LUCKY_INCENTIVE_CONTRACT} '{
  "emergency_pause": {
    "paused": true
  }
}' \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes

echo "✅ Luckee Incentive 已暂停"
echo "紧急暂停完成！"
```

#### 2.2 系统恢复

```bash
#!/bin/bash
# 系统恢复脚本 - system_recovery_luckee_incentive.sh

set -e

echo "开始 Luckee Incentive 系统恢复..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 恢复 Luckee Incentive 合约
echo "恢复 Luckee Incentive 合约..."

wasmd tx wasm execute ${LUCKY_INCENTIVE_CONTRACT} '{
  "emergency_pause": {
    "paused": false
  }
}' \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes

echo "✅ Luckee Incentive 已恢复"
echo "系统恢复完成！"
```

### 3. 备份和恢复

#### 3.1 数据备份

```bash
#!/bin/bash
# 数据备份脚本 - backup_luckee_incentive.sh

set -e

echo "开始 Luckee Incentive 数据备份..."

BACKUP_DIR="/home/lc/luckee_dao/backups/luckee_incentive/$(date +%Y%m%d_%H%M%S)"
mkdir -p ${BACKUP_DIR}

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 备份合约状态
echo "备份 Luckee Incentive 状态..."

# 备份合约配置
wasmd query wasm contract-state smart ${LUCKY_INCENTIVE_CONTRACT} '{"get_config":{}}' \
  --node ${NODE} --output json > ${BACKUP_DIR}/luckee_incentive_config.json

# 备份合约代码
wasmd query wasm code ${LUCKY_INCENTIVE_CONTRACT} \
  --node ${NODE} --output json > ${BACKUP_DIR}/luckee_incentive_code.json

# 备份奖励规则
wasmd query wasm contract-state smart ${LUCKY_INCENTIVE_CONTRACT} '{"get_rules":{}}' \
  --node ${NODE} --output json > ${BACKUP_DIR}/luckee_incentive_rules.json

# 备份注册的合约
wasmd query wasm contract-state smart ${LUCKY_INCENTIVE_CONTRACT} '{"get_registered_contracts":{}}' \
  --node ${NODE} --output json > ${BACKUP_DIR}/luckee_incentive_contracts.json

echo "Luckee Incentive 数据备份完成！备份目录: ${BACKUP_DIR}"
```

## 📈 性能优化

### 1. Gas 优化

```yaml
gas_optimization:
  strategies:
    - "使用批量操作减少交易数量"
    - "优化存储结构减少读写次数"
    - "使用索引提高查询效率"
    - "缓存常用数据避免重复计算"
  
  implementation:
    batch_operations:
      enabled: true
      max_batch_size: 100
      
    storage_optimization:
      enabled: true
      compression: true
      
    query_optimization:
      enabled: true
      index_strategy: "btree"
```

### 2. 响应时间优化

```yaml
response_time_optimization:
  strategies:
    - "异步处理非关键操作"
    - "使用缓存减少重复计算"
    - "优化奖励计算算法"
    - "并行处理独立操作"
  
  implementation:
    async_processing:
      enabled: true
      queue_size: 1000
      
    caching:
      enabled: true
      cache_size: "100MB"
      ttl: "300s"
      
    parallel_processing:
      enabled: true
      max_workers: 10
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始版本创建 | AI Assistant |

---

**注意**: 本文档确保交付物能被正确、高效地部署和运维。所有脚本和配置都经过测试验证，可直接用于生产环境。
